<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Kubebuilder ì‚¬ìš©í•´ì„œ Kubernetes Controller ë§Œë“¤ê¸° | youngchul&#39;s website</title>



<link href="https://youngchul.github.io/index.xml" rel="alternate" type="application/rss+xml" title="youngchul&#39;s website" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://youngchul.github.io/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://youngchul.github.io">
          <h1 class="title is-4">youngchul&#39;s website</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/youngchul'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/youngchul'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:youngchul@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/controller">#Controller</a>
  
  | <a class="subtitle is-6" href="/tags/operator">#Operator</a>
  
  | <a class="subtitle is-6" href="/tags/kubebuilder">#Kubebuilder</a>
  

      
    </div>
    <h2 class="subtitle is-6">August 26, 2019</h2>
    <h1 class="title">Kubebuilder ì‚¬ìš©í•´ì„œ Kubernetes Controller ë§Œë“¤ê¸°</h1>
    
    <div class="content">
      

<p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-controllers" target="_blank">Kubernetes Custom Controller</a>ë¥¼ Go ì–¸ì–´ë¡œ ë§Œë“œëŠ” ë°©ë²•ì€ ë‹¤ì–‘í•©ë‹ˆë‹¤. <a href="https://github.com/kubernetes/client-go" target="_blank">client-go</a> ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•´ì„œ <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/" target="_blank">Kubernetes API</a>ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ì„ ì£¼ë¡œ ì‚¬ìš©í•˜ì§€ë§Œ, <a href="https://github.com/kubernetes/sample-controller" target="_blank">sample-controller</a> ì˜ˆì œì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md" target="_blank">client-go ë¼ì´ë¸Œë¦¬ì˜ ë™ì‘ë°©ì‹ê³¼ ì»´í¬ë„ŒíŠ¸ë“¤</a>ë¥¼ ì´í•´í•˜ê³  ì•Œë§ê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank">Kubebuilder</a> ë˜ëŠ” <a href="https://github.com/operator-framework/operator-sdk" target="_blank">Operator SDK</a> í”„ë ˆì„ì›Œí¬ê°€ client-go ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì˜¬ë°”ë¥¸ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•´ì„œ Kubernetes Controllerë¥¼ ë³´ë‹¤ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.</p>

<p>ì´ ê¸€ì—ì„œëŠ” Kubebuilder v2 ë²„ì „ì„ ì‚¬ìš©í•´ì„œ Memcached Controller ë§Œë“œëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤. Memcached Controller ì½”ë“œëŠ” Operator SDK ì˜ˆì œ ì¤‘ í•˜ë‚˜ì¸ <a href="https://github.com/operator-framework/operator-sdk-samples/tree/master/memcached-operator" target="_blank">memcached-operator</a>ë¥¼ ì°¸ê³ í–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¬¼ì€ <a href="https://github.com/youngchul/memcached-controller" target="_blank">memcached-controller</a> ì €ì¥ì†Œì— ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="kubebuilder">Kubebuilder</h2>

<p>KubebuilderëŠ” CRDsë¥¼ ì‚¬ìš©í•˜ëŠ” Kubernetes APIsë¥¼ ë§Œë“¤ê¸° ìœ„í•œ í”„ë ˆì„ì›Œí¬ë¼ê³  ì†Œê°œí•©ë‹ˆë‹¤.</p>

<blockquote>
<p>Kubebuilder is a framework for building Kubernetes APIs using custom resource definitions (CRDs).
<a href="https://github.com/kubernetes-sigs/kubebuilder#kubebuilder" target="_blank">https://github.com/kubernetes-sigs/kubebuilder#kubebuilder</a></p>
</blockquote>

<p>ìµœê·¼ì— <a href="https://github.com/kubernetes-sigs/kubebuilder/releases/tag/v2.0.0" target="_blank">Kubebuilder v2.0.0</a> ë²„ì „ì´ ì¶œì‹œëìŠµë‹ˆë‹¤. ìµœì‹  ë²„ì „ì€ <a href="https://github.com/kubernetes-sigs/kubebuilder/releases" target="_blank">releases</a> í˜ì´ì§€ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="kubebuilder-ì„¤ì¹˜">Kubebuilder ì„¤ì¹˜</h2>

<p>ë¨¼ì €, <a href="https://blog.golang.org/using-go-modules" target="_blank">Go modules</a>ë¥¼ ì§€ì›í•˜ëŠ” go 1.11 ë²„ì „ ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  <a href="https://github.com/kubernetes-sigs/kustomize" target="_blank">kustomize</a> 3.1.0 ë²„ì „ ì´ìƒë„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. macOSì—ì„œëŠ” <code>brew install</code> ëª…ë ¹ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì„¤ì¹˜í•©ë‹ˆë‹¤. ë‹¤ë¥¸ í™˜ê²½ì—ì„œëŠ” <a href="https://golang.org/doc/install" target="_blank">Go ì„¤ì¹˜ ë¬¸ì„œ</a>ì™€ <a href="https://sigs.k8s.io/kustomize/docs/INSTALL.md" target="_blank">Kustomize ì„¤ì¹˜ ë¬¸ì„œ</a>ë¥¼ ì°¸ê³ í•´ì„œ ì„¤ì¹˜ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<pre><code>$ brew install go kustomize
[...]

# ì„¤ì¹˜ í™•ì¸
$ go version
go version go1.12.9 darwin/amd64
$ kustomize version
Version: {KustomizeVersion:3.1.0 GitCommit:95f3303493fdea243ae83b767978092396169baf BuildDate:2019-07-26T19:21:45+01:00 GoOs:darwin GoArch:amd64}
$
</code></pre>

<p>KubebuilderëŠ” <a href="https://book.kubebuilder.io/quick-start.html#installation" target="_blank">ì„¤ì¹˜ ë¬¸ì„œ</a> ì„¤ëª…ëŒ€ë¡œ ë°”ì´ë„ˆë¦¬ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì„œ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

<pre><code>$ os=$(go env GOOS)
$ arch=$(go env GOARCH)

# download kubebuilder and extract it to tmp
$ curl -sL https://go.kubebuilder.io/dl/2.0.0/${os}/${arch} | tar -xz -C /tmp/

# move to a long-term location and put it on your path
# (you'll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)
sudo mv /tmp/kubebuilder_2.0.0_${os}_${arch} /usr/local/kubebuilder
export PATH=$PATH:/usr/local/kubebuilder/bin

# ì„¤ì¹˜ í™•ì¸
$ kubebuilder version
Version: version.Version{KubeBuilderVersion:&quot;2.0.0&quot;, KubernetesVendor:&quot;1.14.1&quot;, GitCommit:&quot;b31cc5d96dbc91749eb49c2cf600bd951a46d4bd&quot;, BuildDate:&quot;2019-08-22T23:39:53Z&quot;, GoOs:&quot;unknown&quot;, GoArch:&quot;unknown&quot;}
$
</code></pre>

<h2 id="í”„ë¡œì íŠ¸-ë§Œë“¤ê¸°">í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</h2>

<p>ë””ë ‰í† ë¦¬ë¥¼ í•˜ë‚˜ ë§Œë“­ë‹ˆë‹¤. ê·¸ë¦¬ê³  Go modulesë¥¼ ì‚¬ìš©í•˜ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ <code>GO111MODULE</code> í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>

<pre><code>$ mkdir -p memcached-controller
$ cd memcached-controller
$ export GO111MODULE=on
$
</code></pre>

<p>ì´ ì˜ˆì œì—ì„œ ë§Œë“œëŠ” Memcached ë¦¬ì†ŒìŠ¤ëŠ” <code>cache.example.com/v1alpha1</code> API Groupê³¼ <code>Memcached</code> Kindë¡œ ì •ì˜í•©ë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ ë•Œ, <code>--domain</code> ì˜µì…˜ì— <code>example.com</code> ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ê³ , <code>--repo</code> ì˜µì…˜ì— ì €ì¥ì†Œ ì£¼ì†Œë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.</p>

<pre><code>$ kubebuilder init --domain example.com --repo github.com/youngchul/memcached-controller
go mod tidy
Running make...
make
/Users/youngchul/go/bin/controller-gen object:headerFile=./hack/boilerplate.go.txt paths=&quot;./...&quot;
go fmt ./...
go vet ./...
go build -o bin/manager main.go
Next: Define a resource with:
$ kubebuilder create api
$
</code></pre>

<p>í”„ë¡œì íŠ¸ì— í•„ìš”í•œ ê¸°ë³¸ì ì¸ ë””ë ‰í† ë¦¬ì™€ íŒŒì¼ì´ ì•„ë˜ì™€ ê°™ì´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.</p>

<pre><code>$ tree -L 1 -F .
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ PROJECT
â”œâ”€â”€ bin/
â”œâ”€â”€ config/
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ hack/
â””â”€â”€ main.go

3 directories, 6 files
$
</code></pre>

<p>ì£¼ìš” íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
<li><code>go.mod</code>: Go module ê²½ë¡œì™€ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì •ë³´ê°€ ê¸°ë¡ë©ë‹ˆë‹¤. Kubebuilder v2 ë²„ì „ì—ì„œ ì‚¬ìš©í•˜ëŠ” í…œí”Œë¦¿ì€ <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/v2.0.0/pkg/scaffold/v2/gomod.go#L41-L47" target="_blank">pkg/scaffold/v2/gomod.go</a> íŒŒì¼ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
<li><code>Makefile</code>: ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ê³  ë°°í¬í•˜ëŠ” make íƒ€ì¼“ë“¤ì´ ìˆìŠµë‹ˆë‹¤. <a href="https://github.com/kubernetes-sigs/kubebuilder/blob/v2.0.0/pkg/scaffold/v2/makefile.go#L46-L113" target="_blank">pkg/scaffold/v2/makefile.go</a> íŒŒì¼ì—ì„œ Makefile í…œí”Œë¦¿ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
<li><code>PROJECT</code>: Kubebuilder ë©”íƒ€ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. version, domain, repo ì •ë³´ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</li>
<li><code>config/</code>: CRDì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬ í•  ë•Œ ì‚¬ìš©ë˜ëŠ” ì„¤ì • íŒŒì¼ë“¤ì´ ìˆìŠµë‹ˆë‹¤.</li>
<li><code>main.go</code>: ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë©”ë‹ˆì €ë¥¼ ë§Œë“¤ê³  ì‹¤í–‰í•˜ëŠ” <code>main()</code> í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<p><code>kubebuilder init</code> ëª…ë ¹ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ìì„¸í•œ íŒŒì¼ ë‚´ìš©ì€ <a href="https://github.com/youngchul/memcached-controller/commit/ec352f0c686f1038d9967d70005b8df07c49b9b0" target="_blank">ì—¬ê¸°</a>ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="api-ë§Œë“¤ê¸°">API ë§Œë“¤ê¸°</h2>

<p>Memcached ë¦¬ì†ŒìŠ¤ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“­ë‹ˆë‹¤. ìš°ì„ , <code>kubebuilder create api</code> ëª…ë ¹ìœ¼ë¡œ ë¼ˆëŒ€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

<pre><code>$ kubebuilder create api --group cache --version v1alpha1 --kind Memcached
Create Resource [y/n]
y
Create Controller [y/n]
y
Writing scaffold for you to edit...
api/v1alpha1/memcached_types.go
controllers/memcached_controller.go
Running make...
/Users/youngchul/go/bin/controller-gen object:headerFile=./hack/boilerplate.go.txt paths=&quot;./...&quot;
go fmt ./...
go vet ./...
go build -o bin/manager main.go
$
</code></pre>

<p><code>PROJECT</code> íŒŒì¼ì— ë¦¬ì†ŒìŠ¤ê°€ ì¶”ê°€ ë˜ê³ , Memcached íƒ€ì…ì´ <code>api/v1alpha1/memcached_types.go</code> íŒŒì¼ì— ì •ì˜ë˜ë©°, ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” <code>controllers/memcached_controller.go</code> íŒŒì¼ì— ìˆìŠµë‹ˆë‹¤. <code>kubebuilder create api</code> ëª…ë ¹ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ìì„¸í•œ íŒŒì¼ ë‚´ìš©ì€ <a href="https://github.com/youngchul/memcached-controller/commit/32a23c52f9b00b4f9df72bc96aa7475e5921b987" target="_blank">ì—¬ê¸°</a>ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="specê³¼-status-í•„ë“œ-ì¶”ê°€í•˜ê¸°">Specê³¼ Status í•„ë“œ ì¶”ê°€í•˜ê¸°</h3>

<p>Memcached íƒ€ì…ì— ì›í•˜ëŠ” Specê³¼ Status í•„ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. <code>MemcachedSpec.Size</code> í•„ë“œëŠ” deploymentì˜ replicas ê°’ìœ¼ë¡œ ì‚¬ìš©ë˜ê³ , <code>MemcachedStatus.Nodes</code> í•„ë“œëŠ” memcachedê°€ ì‹¤í–‰ ì¤‘ì¸ pods ì´ë¦„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤. Operator SDK ì˜ˆì œì¸ <a href="https://github.com/operator-framework/operator-sdk-samples/blob/bd30254f3a7e3943fdbae33e9b6992bce1e07755/memcached-operator/pkg/apis/cache/v1alpha1/memcached_types.go#L10-L20" target="_blank">Memcached Operator ì½”ë“œ</a>ë¥¼ ì°¸ê³ í•´ì„œ ì•„ë˜ì™€ ê°™ì´ í•„ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.</p>

<pre><code>// MemcachedSpec defines the desired state of Memcached
type MemcachedSpec struct {
    // Size is the size of the memcached deployment
    Size int32 `json:&quot;size&quot;`
}

// MemcachedStatus defines the observed state of Memcached
type MemcachedStatus struct {
    // Nodes are the names of the memcached pods
    Nodes []string `json:&quot;nodes&quot;`
}
</code></pre>

<p>Memcached íƒ€ì…ì„ ë³€ê²½í•˜ë©´ <code>api/v1alpha1/zz_generated.deepcopy.go</code> íŒŒì¼ì„ ë‹¤ì‹œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. <code>make generate</code> ëª…ë ¹ìœ¼ë¡œ <code>controller-gen</code> ë„êµ¬ë¥¼ ì‹¤í–‰í•´ì„œ íŒŒì¼ì„ ë‹¤ì‹œ ë§Œë“­ë‹ˆë‹¤. ê·¸ë¦¬ê³  CRDì™€ ClusterRoleë„ <code>make manifests</code> ëª…ë ¹ìœ¼ë¡œ <code>controller-gen</code>ì„ ì‹¤í–‰í•´ì„œ ê°±ì‹ í•©ë‹ˆë‹¤.</p>

<pre><code>$ make generate
/Users/youngchul/go/bin/controller-gen object:headerFile=./hack/boilerplate.go.txt paths=&quot;./...&quot;
$ make manifests
/Users/youngchul/go/bin/controller-gen &quot;crd:trivialVersions=true&quot; rbac:roleName=manager-role webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
$
</code></pre>

<p>Specê³¼ Status í•„ë“œë¥¼ ì¶”ê°€í•˜ê³  ìƒì„±ëœ íŒŒì¼ ë‚´ìš©ì€ <a href="https://github.com/youngchul/memcached-controller/commit/98175721e36f693d96d1e58c87dd9fb92b595978" target="_blank">ì—¬ê¸°</a>ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="ì»¨íŠ¸ë¡¤ëŸ¬-ë¡œì§-ì¶”ê°€í•˜ê¸°">ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§ ì¶”ê°€í•˜ê¸°</h3>

<p>Memcached ë¦¬ì†ŒìŠ¤ê°€ ì¶”ê°€/ë³€ê²½/ì‚­ì œë˜ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒ í•  ë•Œë§ˆë‹¤ <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/reconcile#Reconciler" target="_blank">Reconcile()</a> ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ê³ , ì—¬ê¸°ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë™ì‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

<ul>
<li>ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ Memcached ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</li>
<li>Deployment ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•´ì„œ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.</li>
<li>Service ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•´ì„œ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.</li>
<li>Memcached ì¸ìŠ¤í„´ìŠ¤ì˜ <code>Spec.Size</code>ì™€ Deployment ì¸ìŠ¤í„´ìŠ¤ì˜ <code>Spec.Replicas</code>ë¥¼ ë¹„êµí•´ì„œ ë‹¤ë¥´ë©´ Deployment ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.</li>
<li>Memcached ì¸ìŠ¤í„´ìŠ¤ì˜ <code>Status.Nodes</code>ë¥¼ í™•ì¸í•´ì„œ ë³€ê²½ì´ ìˆìœ¼ë©´ ê°±ì‹ í•©ë‹ˆë‹¤.</li>
</ul>

<p>Reconcile() ë©”ì†Œë“œì— ì¶”ê°€ëœ ë‚´ìš©ì€ <a href="https://github.com/youngchul/memcached-controller/commit/f2e56b5902df923ea18c27aefdb3df24851a6b12" target="_blank">ì—¬ê¸°</a>ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="í…ŒìŠ¤íŠ¸í•˜ê¸°">í…ŒìŠ¤íŠ¸í•˜ê¸°</h2>

<p>ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. <a href="https://kind.sigs.k8s.io" target="_blank">kind</a>ë¥¼ ì´ìš©í•´ì„œ ë¡œì»¬ì— í…ŒìŠ¤íŠ¸ìš© Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Go 1.11 ë²„ì „ ì´ìƒê³¼ Dockerê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>

<pre><code># kind ì„¤ì¹˜
$ GO111MODULE=&quot;on&quot; go get sigs.k8s.io/kind@v0.5.1
[...]

# Kubernetes í´ëŸ¬ìŠ¤í„° ë§Œë“¤ê¸°
$ kind create cluster
Creating cluster &quot;kind&quot; ...
 âœ“ Ensuring node image (kindest/node:v1.15.3) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Creating kubeadm config ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Cluster creation complete. You can now use the cluster with:

export KUBECONFIG=&quot;$(kind get kubeconfig-path --name=&quot;kind&quot;)&quot;
kubectl cluster-info
$
</code></pre>

<p><code>KUBECONFIG</code> í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>

<pre><code>$ export KUBECONFIG=&quot;$(kind get kubeconfig-path --name=&quot;kind&quot;)&quot;
$ kubectl cluster-info
Kubernetes master is running at https://127.0.0.1:51801
KubeDNS is running at https://127.0.0.1:51801/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
$
</code></pre>

<p>í´ëŸ¬ìŠ¤í„°ì— Memcached CRDë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.</p>

<pre><code>$ make install
/Users/youngchul/go/bin/controller-gen &quot;crd:trivialVersions=true&quot; rbac:roleName=manager-role webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
kustomize build config/crd | kubectl apply -f -
customresourcedefinition.apiextensions.k8s.io/memcacheds.cache.example.com created

# CRD í™•ì¸
$ kubectl get crds
NAME                           CREATED AT
memcacheds.cache.example.com   2019-08-25T12:27:49Z
$
</code></pre>

<p>ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. <code>make run</code> ëª…ë ¹ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.  ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ê³„ì† ì‹¤í–‰ë˜ê³  ìˆê³ , ì‰˜ í”„ë¡¬í”„íŠ¸ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ í›„ë¶€í„°ëŠ” ìƒˆë¡œìš´ í„°ë¯¸ë„ì—ì„œ ëª…ë ¹ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<pre><code>$ make run
/Users/youngchul/go/bin/controller-gen object:headerFile=./hack/boilerplate.go.txt paths=&quot;./...&quot;
go fmt ./...
go vet ./...
/Users/youngchul/go/bin/controller-gen &quot;crd:trivialVersions=true&quot; rbac:roleName=manager-role webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
go run ./main.go
2019-08-25T12:55:45.713+0900    INFO    controller-runtime.metrics      metrics server is starting to listen    {&quot;addr&quot;: &quot;:8080&quot;}
2019-08-25T12:55:45.715+0900    INFO    controller-runtime.controller   Starting EventSource    {&quot;controller&quot;: &quot;memcached&quot;, &quot;source&quot;: &quot;kind source: /, Kind=&quot;}
2019-08-25T12:55:45.715+0900    INFO    controller-runtime.controller   Starting EventSource    {&quot;controller&quot;: &quot;memcached&quot;, &quot;source&quot;: &quot;kind source: /, Kind=&quot;}
2019-08-25T12:55:45.715+0900    INFO    controller-runtime.controller   Starting EventSource    {&quot;controller&quot;: &quot;memcached&quot;, &quot;source&quot;: &quot;kind source: /, Kind=&quot;}
2019-08-25T12:55:45.715+0900    INFO    setup   starting manager
2019-08-25T12:55:45.715+0900    INFO    controller-runtime.manager      starting metrics server {&quot;path&quot;: &quot;/metrics&quot;}
2019-08-25T12:55:45.819+0900    INFO    controller-runtime.controller   Starting Controller     {&quot;controller&quot;: &quot;memcached&quot;}
2019-08-25T12:55:45.920+0900    INFO    controller-runtime.controller   Starting workers        {&quot;controller&quot;: &quot;memcached&quot;, &quot;worker count&quot;: 1}
</code></pre>

<p>Memcached ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

<pre><code>$ kubectl apply -f config/samples/
memcached.cache.example.com/memcached-sample created
$
</code></pre>

<p>ì»¨íŠ¸ë¡¤ëŸ¬ì˜ Reconcile() ë©”ì†Œë“œê°€ Memcached ë¦¬ì†ŒìŠ¤ ì¶”ê°€ ì´ë²¤íŠ¸ë¡œ ì¸í•´ í˜¸ì¶œëê³ , Deploymentì™€ Serviceê°€ ìƒì„± ëœ ê²ƒì„ ë¡œê·¸ì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<pre><code>2019-08-25T12:57:15.942+0900    INFO    controllers.Memcached   Reconciling Memcached   {&quot;memcached&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:15.942+0900    INFO    controllers.Memcached   Creating a new Deployment       {&quot;memcached&quot;: &quot;default/memcached-sample&quot;, &quot;Deployment.Namespace&quot;: &quot;default&quot;, &quot;Deployment.Name&quot;: &quot;memcached-sample&quot;}
2019-08-25T12:57:15.960+0900    INFO    controllers.Memcached   Reconciling Memcached   {&quot;memcached&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:15.960+0900    INFO    controllers.Memcached   Creating a new Service  {&quot;memcached&quot;: &quot;default/memcached-sample&quot;, &quot;Service.Namespace&quot;: &quot;default&quot;, &quot;Service.Name&quot;: &quot;memcached-sample&quot;}
2019-08-25T12:57:15.968+0900    INFO    controllers.Memcached   Reconciling Memcached   {&quot;memcached&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:16.077+0900    DEBUG   controller-runtime.controller   Successfully Reconciled {&quot;controller&quot;: &quot;memcached&quot;, &quot;request&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:16.077+0900    INFO    controllers.Memcached   Reconciling Memcached   {&quot;memcached&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:16.078+0900    DEBUG   controller-runtime.controller   Successfully Reconciled {&quot;controller&quot;: &quot;memcached&quot;, &quot;request&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:17.106+0900    INFO    controllers.Memcached   Reconciling Memcached   {&quot;memcached&quot;: &quot;default/memcached-sample&quot;}
2019-08-25T12:57:17.106+0900    DEBUG   controller-runtime.controller   Successfully Reconciled {&quot;controller&quot;: &quot;memcached&quot;, &quot;request&quot;: &quot;default/memcached-sample&quot;}
</code></pre>

<p>Memcached ë¦¬ì†ŒìŠ¤ì™€ ë”ë¶ˆì–´ Deployment, Pod, Serviceê°€ ìƒì„± ëœ ê²ƒì„ <code>kubectl get</code> ëª…ë ¹ìœ¼ë¡œ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<pre><code>$ kubectl get memcacheds,deployments,pods,services
NAME                                           AGE
memcached.cache.example.com/memcached-sample   1m10s

NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/memcached-sample   1/1     1            1           1m10s

NAME                                    READY   STATUS    RESTARTS   AGE
pod/memcached-sample-79ccbbbbcb-nchrk   1/1     Running   0          1m10s

NAME                       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE
service/kubernetes         ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP     12m
service/memcached-sample   ClusterIP   None         &lt;none&gt;        11211/TCP   1m10s
$
</code></pre>

<p>Memcachedê°€ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ <code>stats</code> ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p>

<pre><code>$ kubectl run -it --rm --restart=Never alpine --image=alpine -- sh -c 'echo stats | nc memcached-sample 11211 | grep uptime'
STAT uptime 51
pod &quot;alpine&quot; deleted
$
</code></pre>

<h3 id="ë¦¬ì†ŒìŠ¤-ì‚­ì œí•˜ê¸°">ë¦¬ì†ŒìŠ¤ ì‚­ì œí•˜ê¸°</h3>

<p>ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì¤‘ë‹¨í•˜ê³  Memcached CRDë¥¼ ì‚­ì œí•˜ë©´ Memcached ë¦¬ì†ŒìŠ¤ì™€ í•˜ìœ„ ë¦¬ì†ŒìŠ¤ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.</p>

<pre><code>$ kubectl delete crds memcacheds.cache.example.com
customresourcedefinition.apiextensions.k8s.io &quot;memcacheds.cache.example.com&quot; deleted
$
</code></pre>

<h2 id="ë°°í¬í•˜ê¸°">ë°°í¬í•˜ê¸°</h2>

<p>ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ë°°í¬í•©ë‹ˆë‹¤. <code>make deploy</code> ëª…ë ¹ìœ¼ë¡œ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ëª¨ë‘ ì„¤ì¹˜ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<pre><code>$ make deploy
/Users/youngchul/go/bin/controller-gen &quot;crd:trivialVersions=true&quot; rbac:roleName=manager-role webhook paths=&quot;./...&quot; output:crd:artifacts:config=config/crd/bases
cd config/manager &amp;&amp; kustomize edit set image controller=youngchul/memcached-controller:latest
kustomize build config/default | kubectl apply -f -
namespace/memcached-controller-system created
customresourcedefinition.apiextensions.k8s.io/memcacheds.cache.example.com created
role.rbac.authorization.k8s.io/memcached-controller-leader-election-role created
clusterrole.rbac.authorization.k8s.io/memcached-controller-manager-role created
clusterrole.rbac.authorization.k8s.io/memcached-controller-proxy-role created
rolebinding.rbac.authorization.k8s.io/memcached-controller-leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/memcached-controller-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/memcached-controller-proxy-rolebinding created
service/memcached-controller-controller-manager-metrics-service created
deployment.apps/memcached-controller-controller-manager created
$
</code></pre>

<p>ì»¨íŠ¸ë¡¤ëŸ¬ê°€ <code>memcached-controller-system</code> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ <code>memcached-controller-controller-manager</code> Deploymentì™€ Podì—ì„œ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<pre><code>$ kubectl get deployments,pods -n memcached-controller-system
NAME                                                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/memcached-controller-controller-manager   1/1     1            1           60s

NAME                                                           READY   STATUS    RESTARTS   AGE
pod/memcached-controller-controller-manager-69c57668dc-hv7tf   2/2     Running   0          60s
$
</code></pre>

<h3 id="ë¦¬ì†ŒìŠ¤-ì‚­ì œí•˜ê¸°-1">ë¦¬ì†ŒìŠ¤ ì‚­ì œí•˜ê¸°</h3>

<p>ë§Œì•½ ë°°í¬ëœ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•˜ë ¤ë©´, ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>

<pre><code>$ kustomize build config/default | kubectl delete -f -
namespace &quot;memcached-controller-system&quot; deleted
customresourcedefinition.apiextensions.k8s.io &quot;memcacheds.cache.example.com&quot; deleted
role.rbac.authorization.k8s.io &quot;memcached-controller-leader-election-role&quot; deleted
clusterrole.rbac.authorization.k8s.io &quot;memcached-controller-manager-role&quot; deleted
clusterrole.rbac.authorization.k8s.io &quot;memcached-controller-proxy-role&quot; deleted
rolebinding.rbac.authorization.k8s.io &quot;memcached-controller-leader-election-rolebinding&quot; deleted
clusterrolebinding.rbac.authorization.k8s.io &quot;memcached-controller-manager-rolebinding&quot; deleted
clusterrolebinding.rbac.authorization.k8s.io &quot;memcached-controller-proxy-rolebinding&quot; deleted
service &quot;memcached-controller-controller-manager-metrics-service&quot; deleted
deployment.apps &quot;memcached-controller-controller-manager&quot; deleted
$
</code></pre>

<h2 id="ë§ˆë¬´ë¦¬">ë§ˆë¬´ë¦¬</h2>

<p>Kubebuilder v2 ë²„ì „ì„ ì‚¬ìš©í•´ì„œ Memcached Controller ë§Œë“œëŠ” ë°©ë²•ì„ ì‚´í´ë³´ê³  í…ŒìŠ¤íŠ¸ í–ˆìŠµë‹ˆë‹¤. client-go ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì´ìš©í•˜ëŠ” ë°©ì‹ì— ë¹„í•´ ì‘ì„±í•´ì•¼ í•˜ëŠ” ì½”ë“œê°€ ì ê³ , ì¢€ ë” ì§ê´€ì ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ êµ¬ì¡°ì™€ ì½”ë“œë¥¼ ì´í•´í•˜ê³  ì‘ì„± í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. Kubebuilder í•˜ìœ„ í”„ë¡œì íŠ¸ì¸ <a href="https://github.com/kubernetes-sigs/controller-runtime" target="_blank">controller-runtime</a>ê³¼ <a href="https://github.com/kubernetes-sigs/controller-tools" target="_blank">controller-tools</a> ë•ë¶„ì…ë‹ˆë‹¤.</p>

<p>ì—¬ëŸ¬ Kubernetes í”„ë¡œì íŠ¸ì—ì„œ Kubebuilderë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, <a href="https://github.com/kubernetes-sigs/cluster-api" target="_blank">Cluster API</a> í”„ë¡œì íŠ¸ì—ì„œ Kubebuilderë¥¼ ì‚¬ìš©í•˜ê³ , <a href="https://cluster-api.sigs.k8s.io/provider_implementations/overview.html" target="_blank">Cluster API Provider</a> ê°œë°œì—ë„ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤. Cluster APIëŠ” Kubernetes APIsì²˜ëŸ¼ ì„ ì–¸ì ì¸ ë°©ì‹ì„ í†µí•´ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ë§Œë“¤ê³  ê´€ë¦¬í•˜ë ¤ê³  í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤. Kubebuilder ì‚¬ìš© ë° ì´í•´ë¥¼ í†µí•´ Kubernetesì™€ ê´€ë ¨ í”„ë¡œì íŠ¸ ì½”ë“œë¥¼ ë³´ë‹¤ ì‰½ê²Œ ì´í•´í•˜ê³  ì ‘ê·¼í•˜ëŠ”ë° ë„ì›€ì´ ë˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.</p>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <div id="show_comments"><a id="load_comments" class="button is-link">Load comments</a></div>
  
    <script type="text/javascript">
      var disqus_shortname = 'youngchul';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      
      var hash = window.location.hash.substr(1);
      if ((hash.length > 8) && (hash.substring(0, 8) === "comment-")) {
        disqus();
        document.getElementById("show_comments").style.display = "none";
      } else {
        document.getElementById('load_comments').onclick = function() {
          disqus();
          document.getElementById("show_comments").style.display = "none";
        };
      }
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; 2019 ë°©ì˜ì²  (Youngchul Bang)</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-143774634-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

